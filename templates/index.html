<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Simulador de Protocolo - Proyecto</title>
<style>
    :root{
    --bg: linear-gradient(135deg, #e6f0ff, #cfe0ff);
    --panel: #ffffffee;
    --muted: #496dac;
    --accent: #0c7ff1;
    --accent-2: #0658a5;
    --border: #b5c9e6;
    --text: #0d1b2a;
    }
    body{font-family:Inter,Arial,sans-serif;margin:0;padding:24px;background:var(--bg);color:var(--text);min-height:100vh;}
    .container{max-width:980px;margin:0 auto;background:var(--panel);padding:24px;border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.06)}

  /* HERO */
    .hero {
    background: linear-gradient(135deg,#0c7ff1,#4dabff);
    color:#fff; padding:18px 20px; border-radius:14px;
    box-shadow: 0 10px 22px rgba(12,127,241,.25);
    display:flex; align-items:center; gap:10px; margin-bottom:16px;
    }
    .hero .badge {
    background: #ffffff20; border:1px solid #ffffff40;
    padding:6px 10px; border-radius:999px; font-size:12px;
    }

  /* FORM */
    form{display:flex;flex-direction:column;gap:12px;margin-bottom:18px}
    label{font-weight:600}
    textarea,input[type="text"],input[type="number"],input[type="file"],select{
    width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:6px;padding:8px;background:#f8faff;
    transition:border-color .15s ease, box-shadow .15s ease;
    }
    textarea:hover,input:hover,select:hover{ border-color:#97b6ea }
    textarea:focus,input:focus,select:focus{
    outline:0; border-color:#4d9eff;
    box-shadow: 0 0 0 3px rgba(77,158,255,.25);
    }
    .row{display:flex;gap:10px;align-items:center}
    .row>label{min-width:130px}

  /* BUTTONS */
    button{
    background:var(--accent);color:#fff;border:0;border-radius:10px;padding:8px 14px;cursor:pointer;
    letter-spacing:.2px; transition:transform .05s ease, filter .15s ease;
    }
    button:hover{filter:brightness(0.96)}
    button:active{ transform: translateY(1px) scale(.99) }
    button.ghost{ background:#fff;color:var(--accent);border:1px solid var(--border) }
    button.primary{ background: linear-gradient(135deg,#0c7ff1,#0a6bd1) }

  /* TEXT + PRE */
    pre, code {font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    pre.box{white-space:pre-wrap;background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;max-height:360px;overflow:auto;box-shadow:0 6px 16px rgba(0,0,0,.04)}
    small.muted{color:var(--muted)}
    #status{margin-top:8px}

  /* CAROUSEL */
    .carousel-wrap{margin-top:14px}
    .carousel-head{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px}
    .carousel-head .left{display:flex;align-items:center;gap:10px}
    .pill{
    background:#eef4ff; color:#274b8e; border:1px solid #d2e0ff;
    padding:6px 10px; border-radius:999px; font-size:12px;
    }
    .carousel-viewport{
    position:relative; overflow:hidden; width:100%;
    border:1px solid var(--border); border-radius:14px; background:#fff;
    box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .carousel-track{ display:flex; transition: transform .45s ease; will-change: transform; }
    .slide{ min-width:100%; box-sizing:border-box; padding:16px; }
    .slide-card{ border:1px solid var(--border); border-radius:14px; padding:16px; background:#f9fbff; box-shadow:0 6px 16px rgba(0,0,0,.04) }
    .slide h4{margin:0 0 8px 0; color:var(--accent); display:flex; align-items:center; gap:8px}
    .slide h4 .ic { font-size:18px; width:22px; text-align:center }
    .slide .detail{ white-space:pre-wrap; background:#fff; border:1px dashed #d7e6ff; border-radius:8px; padding:10px; max-height:240px; overflow:auto; line-height:1.35 }

    .nav-btn{
    position:absolute; top:50%; transform:translateY(-50%);
    background:#ffffffcc; border:1px solid var(--border); color:var(--accent);
    width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; backdrop-filter: blur(4px); box-shadow:0 6px 16px rgba(0,0,0,.15)
    }
    .nav-btn:hover{background:#fff}
    .nav-btn:active{ transform:translateY(-50%) translateY(1px) }
    .nav-prev{left:8px}
    .nav-next{right:8px}

    .dots{display:flex; gap:6px; justify-content:center; margin-top:10px}
    .dot{
    width:12px; height:12px; border-radius:999px; background:#cfe0ff; cursor:pointer; border:1px solid var(--border);
    transition: transform .15s ease, background .15s ease;
    }
    .dot.active{background:var(--accent); transform:scale(1.15)}

    .progress {
    height:6px; background:#e6eefc; border-radius:999px; overflow:hidden; margin:10px 2px 0 2px;
    border:1px solid var(--border);
    }
    .progress > .bar {
    height:100%; width:0%;
    background: linear-gradient(135deg,#4dabff,#0c7ff1);
    transition: width .45s ease;
    }

  /* SKELETON */
    .skeleton {
    animation: pulse 1.2s ease-in-out infinite;
    background: linear-gradient(90deg,#f2f6ff,#e9f0ff,#f2f6ff);
    background-size: 200% 100%;
    }
    @keyframes pulse { 0%{background-position:0% 50%} 100%{background-position:100% 50%} }
</style>
</head>
<body>
<div class="container">

    <!-- HERO modernizado -->
    <div class="hero">
    <div style="font-size:22px">ðŸ“¡ Simulador de Protocolo</div>
    <span class="badge">Demo interactiva</span>
    </div>

    <!-- ======= FORM ======= -->
    <form id="form" action="/process" method="post" enctype="multipart/form-data">
    <label for="payload_text">Texto:</label>
    <textarea id="payload_text" name="payload_text" rows="4"></textarea>

    <label for="file">O subir imagen:</label>
    <input id="file" name="file" type="file" accept="image/*">

    <div class="row" id="row-dst-ip">
    <label for="dst_ip">IP Destino</label>
    <input id="dst_ip" name="dst_ip" type="text" value="10.0.0.2">
    </div>

    <div class="row">
    <label for="src_ip">IP Origen</label>
    <input id="src_ip" name="src_ip" type="text" value="10.0.0.1">
    </div>

    <div class="row">
    <label for="mtu">MTU (bytes)</label>
    <input id="mtu" name="mtu" type="number" value="50" min="1" step="1">
    </div>

    <small id="limits-info" class="muted"></small>

    <button type="submit" class="primary">Procesar</button>
    </form>

    <!-- (opcional) panel de entregas; con unicast normalmente no se muestra -->
    <div id="deliveries-panel" style="display:none;margin:10px 0">
    <label for="deliveries_select">Entrega (destino):</label>
    <select id="deliveries_select"></select>
    </div>

    <!-- ======= RESUMEN diferido ======= -->
    <h3 style="color:var(--accent); text-align:center; margin:10px 0">Resultado (resumen)</h3>
    <div style="margin:10px 0; display:flex; gap:8px; flex-wrap:wrap">
    <button id="btnShowSummary" type="button" disabled>Mostrar resumen</button>
    <button id="btnDownloadFull" type="button" class="ghost" disabled>Descargar JSON completo</button>
    <button id="btnReassemble"  type="button" class="ghost" disabled>Reensamblar en destino</button>
    <button id="btnDownloadById" type="button" class="ghost" disabled>Descargar por ID</button>
    </div>
    <pre id="summary_box" class="box">Esperando acciÃ³nâ€¦</pre>

    <!-- ======= CARRUSEL DE CAPAS ======= -->
    <div class="carousel-wrap">
    <div class="carousel-head">
    <div class="left">
        <span class="pill" id="carouselCounter">Paso 0/0</span>
        <button id="carouselPlay" class="ghost" type="button">Play</button>
    </div>
    <div class="right">
        <small class="muted">
    process_id: <code id="pidLabel"></code>
    (<span id="expiresLabel">--:--</span>)
    â€” <a id="viewJsonLink" href="#" target="_blank">Ver resultado (JSON)</a>
        </small>
    </div>
    </div>

    <div class="carousel-viewport">
    <div class="carousel-track" id="carouselTrack"></div>
    <button class="nav-btn nav-prev" id="navPrev" aria-label="Anterior">â€¹</button>
    <button class="nav-btn nav-next" id="navNext" aria-label="Siguiente">â€º</button>
    </div>
    <div class="dots" id="carouselDots"></div>
    <div class="progress"><div id="carouselProgress" class="bar"></div></div>
    </div>

    <div id="status" class="muted" style="margin-top:10px"></div>
</div>

<script>
  // ====== Constantes cliente ======
  const MAX_UPLOAD_BYTES = 5 * 1024 * 1024;
    const MIN_MTU = 1;
    const MAX_MTU = 65535;

  // ====== UI refs ======
    const form = document.getElementById('form');
    const summaryBox = document.getElementById('summary_box');
    const statusEl = document.getElementById('status');
    const pidLabel = document.getElementById('pidLabel');
    const expiresLabel = document.getElementById('expiresLabel');
    const viewJsonLink = document.getElementById('viewJsonLink');

    const btnDownloadFull = document.getElementById('btnDownloadFull');
    const btnDownloadById  = document.getElementById('btnDownloadById');
    const btnReassemble    = document.getElementById('btnReassemble');
    const btnShowSummary   = document.getElementById('btnShowSummary');

    const limitsInfo = document.getElementById('limits-info');
    limitsInfo.textContent = `LÃ­mites: archivo â‰¤ ${Math.round(MAX_UPLOAD_BYTES/1024)} KB, MTU entre ${MIN_MTU} y ${MAX_MTU}.`;

  // ====== Estado ======
    let currentPid = null;
    let expireTimer = null;

  // Resumen diferido
    let pendingSummary = null;
    let summaryVisible = false;

  // Carousel state
    const track = document.getElementById('carouselTrack');
    const dots  = document.getElementById('carouselDots');
    const counter = document.getElementById('carouselCounter');
    const btnPrev = document.getElementById('navPrev');
    const btnNext = document.getElementById('navNext');
    const btnPlay = document.getElementById('carouselPlay');
    const progress = document.getElementById('carouselProgress');

    let slides = [];    // [{title, detail}, ...]
    let idx = 0;
    let autoTimer = null;

  // ====== Submit ======
    form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusEl.textContent = 'Procesandoâ€¦';
    summaryBox.textContent = '';
    summaryBox.classList.add('skeleton');
    btnShowSummary.disabled = true;
    btnShowSummary.textContent = 'Mostrar resumen';
    summaryVisible = false;

    // Validar MTU
    const mtuEl = document.getElementById('mtu');
    let mtuVal = parseInt(mtuEl.value || '50', 10);
    if (isNaN(mtuVal)) mtuVal = 50;
    mtuVal = Math.max(MIN_MTU, Math.min(MAX_MTU, mtuVal));
    mtuEl.value = mtuVal;

    // FormData
    const fd = new FormData(form);
    const file = document.getElementById('file').files[0];
    if (file && file.size > MAX_UPLOAD_BYTES){
    statusEl.textContent = `Archivo demasiado grande (${Math.round(file.size/1024)} KB)`;
    summaryBox.classList.remove('skeleton');
    summaryBox.textContent = 'Cancelado: archivo demasiado grande.';
    return;
    }

    try{
    const res = await fetch('/process', { method:'POST', body: fd });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error(`Respuesta no-JSON (${res.status})\n${text}`); }
    if (!res.ok) throw new Error(data?.detail ? JSON.stringify(data.detail) : `HTTP ${res.status}`);

    onProcessComplete(data);
    }catch(err){
    summaryBox.classList.remove('skeleton');
    statusEl.textContent = 'Error en la solicitud';
    summaryBox.textContent = String(err);
    }
    });

  // ====== Helpers ======
    function formatSummary(s){
    const lines = [];
    lines.push(`- Application (Interfaz de Usuario):`);
    lines.push(`- Presentation (Codificador):`);
    if (s.Presentation){
    lines.push(`type: ${s.Presentation.type}`);
    lines.push(`raw_bytes_len: ${s.Presentation.raw_bytes_len}`);
    lines.push(`encoding: ${s.Presentation.encoding}`);
    }
    lines.push(`- Transport:`);
    if (s.Transport){
    lines.push(`requested_mtu: ${s.Transport.requested_mtu}`);
    lines.push(`total_len: ${s.Transport.total_len}`);
    lines.push(`fragments_count: ${s.Transport.fragments_count}`);
    (s.Transport.fragments || []).forEach(f => lines.push(`- ${f}`));
    }
    lines.push(`- Network:`);
    if (s.Network) lines.push(`network_fragments: ${s.Network.network_fragments}`);
    lines.push(`- Physical (TransmisiÃ³n Visual):`);
    if (s.Physical) lines.push(`logs: ${s.Physical.logs?.length || 0} entries`);
    return lines.join('\n');
    }

    function startExpireCountdown(seconds){
    if (expireTimer) clearInterval(expireTimer);
    let remaining = Math.max(0, parseInt(seconds || 0, 10));
    const tick = ()=>{
    const m = Math.floor(remaining/60);
    const s = remaining%60;
    expiresLabel.textContent = `expira en ${m}:${String(s).padStart(2,'0')}`;
    remaining = Math.max(0, remaining-1);
    };
    tick();
    expireTimer = setInterval(tick, 1000);
    }

  // ====== Carousel utils ======
    function iconFor(title='') {
    const t = title.toLowerCase();
    if (t.includes('application'))  return 'ðŸ§‘â€ðŸ’»';
    if (t.includes('presentation')) return 'ðŸ§©';
    if (t.includes('transport'))    return 'âœ‚ï¸';
    if (t.includes('network'))      return 'ðŸŒ';
    if (t.includes('physical'))     return 'ðŸ“¡';
    return 'ðŸ“¦';
    }

    function buildCarousel(stepArray){
    slides = Array.isArray(stepArray) ? stepArray : [];
    track.innerHTML = '';
    dots.innerHTML = '';
    idx = 0;
    stopAuto();

    slides.forEach((s, i)=>{
    const slide = document.createElement('div');
    slide.className = 'slide';
    slide.innerHTML = `
        <div class="slide-card">
        <h4><span class="ic">${iconFor(s.title)}</span>${s.title || 'Layer'}</h4>
        <div class="detail">${(s.detail || '').replaceAll('<','&lt;').replaceAll('>','&gt;')}</div>
        </div>
    `;
    track.appendChild(slide);

    const d = document.createElement('div');
    d.className = 'dot' + (i===0?' active':'');
    d.onclick = ()=> goTo(i);
    dots.appendChild(d);
    });

    updateCarousel();
    }

    function updateCarousel(){
    const x = -idx * 100;
    track.style.transform = `translateX(${x}%)`;
    counter.textContent = `Paso ${slides.length ? idx+1 : 0}/${slides.length}`;
    Array.from(dots.children).forEach((d,i)=> d.classList.toggle('active', i===idx));
    if (progress && slides.length) {
      progress.style.width = `${((idx + 1) / slides.length) * 100}%`;
    }
    }

    function next(){ if (!slides.length) return; idx = (idx+1) % slides.length; updateCarousel(); }
    function prev(){ if (!slides.length) return; idx = (idx-1+slides.length) % slides.length; updateCarousel(); }
    function goTo(i){ if (!slides.length) return; idx = Math.max(0, Math.min(slides.length-1, i)); updateCarousel(); }

    function play(){
    if (autoTimer || !slides.length) return;
    btnPlay.textContent = 'Pause';
    autoTimer = setInterval(next, 900);
    }
    function stopAuto(){
    if (autoTimer){ clearInterval(autoTimer); autoTimer = null; }
    btnPlay.textContent = 'Play';
    }
    document.getElementById('navPrev').onclick = ()=>{ stopAuto(); prev(); };
    document.getElementById('navNext').onclick = ()=>{ stopAuto(); next(); };
    btnPlay.onclick = ()=>{ autoTimer ? stopAuto() : play(); };

  // swipe soporte bÃ¡sico (mÃ³vil)
    let startX = null;
    track.addEventListener('touchstart', e=> startX = e.touches[0].clientX);
    track.addEventListener('touchend', e=>{
    if (startX===null) return;
    const dx = e.changedTouches[0].clientX - startX;
    if (Math.abs(dx) > 40){ dx<0 ? next() : prev(); }
    startX = null;
    });

  // ====== BotÃ³n Mostrar/Ocultar resumen ======
    btnShowSummary.onclick = ()=>{
    if (!pendingSummary) return;
    summaryVisible = !summaryVisible;
    if (summaryVisible){
    summaryBox.textContent = formatSummary(pendingSummary);
    btnShowSummary.textContent = 'Ocultar resumen';
    } else {
    summaryBox.textContent = 'Resumen oculto. Presiona "Mostrar resumen".';
    btnShowSummary.textContent = 'Mostrar resumen';
    }
    };

  // ====== Acciones auxiliares ======
    btnDownloadFull.onclick = async ()=>{
    if (!currentPid) return;
    const r = await fetch(`/result/${currentPid}`);
    const blob = new Blob([await r.text()], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `result_${currentPid}.json`;
    a.click();
    };

    btnDownloadById.onclick = ()=>{
    if (!currentPid) return;
    window.location.href = `/download/${currentPid}`;
    };

    btnReassemble.onclick = async ()=>{
    if (!currentPid) return;
    const fd = new FormData();
    fd.append('pid', currentPid);
    const sel = document.getElementById('deliveries_select');
    if (sel && sel.value) fd.append('dst_ip', sel.value);
    const r = await fetch('/reassemble', { method:'POST', body: fd });
    statusEl.textContent = r.ok ? 'Reensamblado OK' : `Error HTTP ${r.status}`;
    };

    function renderDeliveries(deliveriesSummary){
    const panel = document.getElementById('deliveries-panel');
    const select = document.getElementById('deliveries_select');
    select.innerHTML = '';
    if (!deliveriesSummary || !deliveriesSummary.length){
    panel.style.display = 'none';
    return;
    }
    panel.style.display = '';
    deliveriesSummary.forEach((d, i)=>{
    const opt = document.createElement('option');
    opt.value = d.dst_ip;
    opt.textContent = `${d.dst_ip} â€” ${d.fragments} frags`;
    if (i===0) opt.selected = true;
    select.appendChild(opt);
    });
    }

  // ====== Al completar /process ======
    function onProcessComplete(resp){
    summaryBox.classList.remove('skeleton');

    currentPid = resp.pid || null;
    pidLabel.textContent = currentPid || '';
    viewJsonLink.href = currentPid ? `/result/${currentPid}` : '#';

    // Resumen diferido (no mostrar hasta botÃ³n)
    pendingSummary = resp.summary || {};
    summaryVisible = false;
    summaryBox.textContent = 'Resumen oculto. Presiona "Mostrar resumen".';
    btnShowSummary.disabled   = false;
    btnDownloadFull.disabled  = false;
    btnReassemble.disabled    = false;
    btnDownloadById.disabled  = false;

    // Carousel con pasos
    buildCarousel(resp.steps || []);
    stopAuto(); // inicia pausado

    // ExpiraciÃ³n e info extra
    startExpireCountdown(resp.expires_in || 0);
    renderDeliveries(resp.deliveries_summary || []);

    statusEl.textContent = 'Listo âœ”';
    }
</script>
</body>
</html>
